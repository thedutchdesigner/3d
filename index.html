<!DOCTYPE html>
<html>
<head>
  <title>AR Post Office Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      background: black;
    }
    video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
    }
    #marker {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 50px;
      height: 50px;
      margin-left: -25px;
      margin-top: -25px;
      background: url('https://cdn-icons-png.flaticon.com/512/684/684908.png') no-repeat center center;
      background-size: contain;
      display: none;
      z-index: 2;
    }
    #enableMotion {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 10px;
      background: black;
      color: white;
      z-index: 3;
      display: none;
    }
  </style>
</head>
<body>

<video id="camera" autoplay playsinline></video>
<div id="marker"></div>
<button id="enableMotion">Enable Motion Tracking</button>

<script>
  let targetBearing = null;
  let userLat = null;
  let userLon = null;

  function getBearing(lat1, lon1, lat2, lon2) {
    const toRad = deg => deg * Math.PI / 180;
    const toDeg = rad => rad * 180 / Math.PI;
    const dLon = toRad(lon2 - lon1);
    const y = Math.sin(dLon) * Math.cos(toRad(lat2));
    const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
              Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
    return (toDeg(Math.atan2(y, x)) + 360) % 360;
  }

  async function getNearestPostOffice(lat, lon) {
    const query = `
      [out:json];
      (
        node["amenity"="post_office"](around:1500,${lat},${lon});
        way["amenity"="post_office"](around:1500,${lat},${lon});
      );
      out center 1;
    `;
    const res = await fetch('https://overpass-api.de/api/interpreter', {
      method: 'POST',
      body: query
    });
    const data = await res.json();
    if (!data.elements.length) return null;

    const el = data.elements[0];
    const lat2 = el.lat || el.center.lat;
    const lon2 = el.lon || el.center.lon;

    return { lat: lat2, lon: lon2 };
  }

  function setupOrientationTracking() {
    function handleOrientation(event) {
      let heading = event.alpha;
      if (typeof heading !== 'number' || targetBearing === null) return;

      heading = 360 - heading;
      const delta = Math.abs(targetBearing - heading);
      const angleDiff = Math.min(delta, 360 - delta);
      const inFOV = angleDiff <= 15;

      document.getElementById('marker').style.display = inFOV ? 'block' : 'none';
    }

    if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
      const btn = document.getElementById('enableMotion');
      btn.style.display = 'block';
      btn.onclick = () => {
        DeviceOrientationEvent.requestPermission().then(response => {
          if (response === 'granted') {
            window.addEventListener('deviceorientation', handleOrientation, true);
            btn.remove();
          }
        });
      };
    } else {
      window.addEventListener('deviceorientation', handleOrientation, true);
    }
  }

  async function init() {
    // Start camera
    const video = document.getElementById('camera');
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
    } catch (err) {
      alert("Camera access denied.");
      console.error(err);
    }

    // Get location
    navigator.geolocation.getCurrentPosition(async (pos) => {
      userLat = pos.coords.latitude;
      userLon = pos.coords.longitude;
      const postOffice = await getNearestPostOffice(userLat, userLon);
      if (!postOffice) {
        alert("No post office nearby.");
        return;
      }

      targetBearing = getBearing(userLat, userLon, postOffice.lat, postOffice.lon);
      setupOrientationTracking();
    }, (err) => {
      alert("Location is required.");
      console.error(err);
    });
  }

  init();
</script>
</body>
</html>
