<!DOCTYPE html>
<html>
<head>
  <title>3D Map Post Office Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #enableMotion {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 10px 15px;
      background: #000;
      color: #fff;
      border: none;
      font-size: 16px;
      z-index: 999;
      display: none;
    }
  </style>
</head>
<body>

<div id="map"></div>
<button id="enableMotion">Enable Motion Tracking</button>

<script>
  const maptilerKey = 'KtkfQkx8DxnyjkBQfUeS';
  let marker = null;
  let targetBearing = null;

  function getBearing(lat1, lon1, lat2, lon2) {
    const toRad = deg => deg * Math.PI / 180;
    const toDeg = rad => rad * 180 / Math.PI;
    const dLon = toRad(lon2 - lon1);
    const y = Math.sin(dLon) * Math.cos(toRad(lat2));
    const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
              Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
    return (toDeg(Math.atan2(y, x)) + 360) % 360;
  }

  navigator.geolocation.getCurrentPosition(async (pos) => {
    const { latitude, longitude } = pos.coords;

    const map = new maplibregl.Map({
      container: 'map',
      style: `https://api.maptiler.com/maps/streets/style.json?key=${maptilerKey}`,
      center: [longitude, latitude],
      zoom: 16,
      pitch: 60,
      bearing: 0,
      antialias: true
    });

    map.on('load', () => {
      map.addLayer({
        id: '3d-buildings',
        source: 'openmaptiles',
        'source-layer': 'building',
        filter: ['==', 'extrude', 'true'],
        type: 'fill-extrusion',
        minzoom: 15,
        paint: {
          'fill-extrusion-color': '#aaa',
          'fill-extrusion-height': ['get', 'height'],
          'fill-extrusion-base': ['get', 'min_height'],
          'fill-extrusion-opacity': 0.6
        }
      });
    });

    const query = `
      [out:json];
      (
        node["amenity"="post_office"](around:1500,${latitude},${longitude});
        way["amenity"="post_office"](around:1500,${latitude},${longitude});
      );
      out center 1;
    `;

    const res = await fetch('https://overpass-api.de/api/interpreter', {
      method: 'POST',
      body: query
    });

    const data = await res.json();
    if (!data.elements || data.elements.length === 0) {
      alert("No post office found nearby.");
      return;
    }

    const target = data.elements[0];
    const targetLat = target.lat || target.center.lat;
    const targetLon = target.lon || target.center.lon;
    targetBearing = getBearing(latitude, longitude, targetLat, targetLon);

    marker = new maplibregl.Marker({ color: 'red' })
      .setLngLat([targetLon, targetLat])
      .setPopup(new maplibregl.Popup().setText("Nearest Post Office"));

    function handleOrientation(event) {
      let heading = event.alpha;
      if (typeof heading !== 'number') return;
      heading = 360 - heading;

      const fov = 30;
      const delta = Math.abs(targetBearing - heading);
      const angleDiff = Math.min(delta, 360 - delta);

      if (angleDiff <= fov) {
        if (!marker._map) marker.addTo(map);
      } else {
        if (marker._map) marker.remove();
      }

      map.rotateTo(heading, { duration: 0 });
    }

    // iOS motion permission
    const btn = document.getElementById('enableMotion');
    if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
      btn.style.display = 'block';
      btn.onclick = () => {
        DeviceOrientationEvent.requestPermission().then(response => {
          if (response === 'granted') {
            window.addEventListener('deviceorientation', handleOrientation, true);
            btn.remove();
          }
        });
      };
    } else {
      window.addEventListener('deviceorientation', handleOrientation, true);
    }

  }, (err) => {
    alert("Geolocation is required.");
    console.error(err);
  });
</script>

</body>
</html>
